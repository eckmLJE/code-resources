# REST API with Express.js in Node.js

Sourced from Robert Wieruch
https://www.robinwieruch.de/node-express-server-rest-api/

## Basic Routes

index.js:

```javascript
app.get("/", (req, res) => {
  return res.send("Received a GET HTTP method");
});

app.post("/", (req, res) => {
  return res.send("Received a POST HTTP method");
});

app.put("/", (req, res) => {
  return res.send("Received a PUT HTTP method");
});

app.delete("/", (req, res) => {
  return res.send("Received a DELETE HTTP method");
});
```

## Routes w/ Resources (fake db)

```javascript
app.get("/users", (req, res) => {
  return res.send(Object.values(users));
});

app.get("/users/:userId", (req, res) => {
  return res.send(users[req.params.userId]);
});

app.post("/users", (req, res) => {
  return res.send("POST HTTP method on user resource");
});

app.put("/users", (req, res) => {
  return res.send("PUT HTTP method on user resource");
});

app.delete("/users", (req, res) => {
  return res.send("DELETE HTTP method on user resource");
});

// Routes: Message Resource

app.get("/messages", (req, res) => {
  return res.send(Object.values(messages));
});

app.get("/messages/:messageId", (req, res) => {
  return res.send(messages[req.params.messageId]);
});

// Fake Database

let users = {
  1: {
    id: "1",
    username: "Robin Wieruch"
  },
  2: {
    id: "2",
    username: "Dave Davids"
  }
};

let messages = {
  1: {
    id: "1",
    text: "Hello World",
    userId: "1"
  },
  2: {
    id: "2",
    text: "By World",
    userId: "2"
  }
};
```

## Post route with id generated by uuid

uuid generates unique ids for new records in our fake database
`npm install uuid`

express doesn't handle parsing HTTP POST body out of the box, use well-known body-parser lib
`npm install body-parser`

import uuid and body-parser and use body-parser

```javascript
import bodyParser from "body-parser";
import uuidv4 from "uuid/v4";

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
```

Add POST route

```javascript
app.post("/messages", (req, res) => {
  const id = uuidv4();
  const message = {
    id,
    text: req.body.text
  };

  messages[id] = message;

  return res.send(message);
});
```

Test w/ post request:
`curl -X POST -H "Content-Type:application/json" http://localhost:3000/messages -d '{"text":"Hi again, World"}'`

Response should include both unique id and the message. Visit http://localhost:3000/messages in browser and you should see your new message there.

## Custom Application-Level Middleware

Middleware blueprint:

```javascript
app.use((req, res, next) => {
  // do something
  next();
});
```

### Fake Auth

pseudo-auth middleware:

```javascript
app.use((req, res, next) => {
  req.me = users[1];
  next();
});
```

new messages resource POST action:

```javascript
app.post("/messages", (req, res) => {
  const id = uuidv4();
  const message = {
    id,
    text: req.body.text,
    userId: req.me.id
  };

  messages[id] = message;

  return res.send(message);
});
```

## Delete Route

```javascript
app.delete("/messages/:messageId", (req, res) => {
  const { [req.params.messageId]: message, ...otherMessages } = messages;

  messages = otherMessages;

  return res.send(message);
});
```

Test:
`curl -X DELETE http://localhost:3000/messages/1`

## Session / User Auth Resource / Route

```javascript
app.get("/session", (req, res) => {
  return res.send(users[req.me.id]);
});
```

## REFACTOR - Modular Models

### Fake DB in models/index.js

```bash
mkdir src/models
touch src/models/index.js
```

models/index.js would typically be where the application interfaces with the database.

In this example we'll use a fake dataset.

Move fake data into models/index.js

in src/index.js:

import models and edit custom middleware to add new context

```javascript
import models from "./models";

app.use((req, res, next) => {
  req.context = {
    models,
    me: models.users[1]
  };
  next();
});
```

### New Routes using custom middleware context

```javascript
app.get("/session", (req, res) => {
  return res.send(req.context.models.users[req.context.me.id]);
});

app.get("/users", (req, res) => {
  return res.send(Object.values(req.context.models.users));
});

app.get("/users/:userId", (req, res) => {
  return res.send(req.context.models.users[req.params.userId]);
});

app.get("/messages", (req, res) => {
  return res.send(Object.values(req.context.models.messages));
});

app.get("/messages/:messageId", (req, res) => {
  return res.send(req.context.models.messages[req.params.messageId]);
});

app.post("/messages", (req, res) => {
  const id = uuidv4();
  const message = {
    id,
    text: req.body.text,
    userId: req.context.me.id
  };

  req.context.models.messages[id] = message;

  return res.send(message);
});

app.delete("/messages/:messageId", (req, res) => {
  const {
    [req.params.messageId]: message,
    ...otherMessages
  } = req.context.models.messages;

  req.context.models.messages = otherMessages;

  return res.send(message);
});
```

### Routes in src/routes

```bash
mkdir routes
cd routes
touch index.js session.js user.js message.js
```

Final Doc Contents:

#### src/index.js:

```javascript
import "dotenv/config";
import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import models from "./models";
import routes from "./routes";

const app = express();

app.use(cors());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

app.use((req, res, next) => {
  req.context = {
    models,
    me: models.users[1]
  };
  next();
});

app.listen(3000, () => console.log("Example app listening on port 3000!"));

// Routes

app.use("/session", routes.session);
app.use("/users", routes.user);
app.use("/messages", routes.message);
```

#### src/models/index.js

// Fake Database

```javascript
let users = {
  1: {
    id: "1",
    username: "Robin Wieruch"
  },
  2: {
    id: "2",
    username: "Dave Davids"
  }
};

let messages = {
  1: {
    id: "1",
    text: "Hello World",
    userId: "1"
  },
  2: {
    id: "2",
    text: "By World",
    userId: "2"
  }
};
```

#### src/routes/index.js

```javascript
import session from "./session";
import user from "./user";
import message from "./message";

export default {
  session,
  user,
  message
};
```

#### src/routes/

##### session.js

```javascript
import { Router } from "express";

const router = Router();

router.get("/", (req, res) => {
  return res.send(req.context.models.users[req.context.me.id]);
});

export default router;
```

##### user.js

```javascript
import { Router } from "express";

const router = Router();

router.get("/", (req, res) => {
  return res.send(Object.values(req.context.models.users));
});

router.get("/:userId", (req, res) => {
  return res.send(req.context.models.users[req.params.userId]);
});

export default router;
```

##### message.js

```javascript
import uuidv4 from "uuid/v4";
import { Router } from "express";

const router = Router();

router.get("/", (req, res) => {
  return res.send(Object.values(req.context.models.messages));
});

router.get("/:messageId", (req, res) => {
  return res.send(req.context.models.messages[req.params.messageId]);
});

router.post("/", (req, res) => {
  const id = uuidv4();
  const message = {
    id,
    text: req.body.text,
    userId: req.context.me.id
  };

  req.context.models.messages[id] = message;

  return res.send(message);
});

router.delete("/:messageId", (req, res) => {
  const {
    [req.params.messageId]: message,
    ...otherMessages
  } = req.context.models.messages;

  req.context.models.messages = otherMessages;

  return res.send(message);
});

export default router;
```
